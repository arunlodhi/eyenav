<h1>movements.js</h1>
<pre><code class="lang-js">define(<span class="function"><span class="keyword">function</span> <span class="params">(require, exports, module)</span> {</span>
  <span class="string">'use strict'</span>;

  <span class="keyword">var</span> EditorManager = brackets.getModule(<span class="string">'editor/EditorManager'</span>),
    EventDispatcher = brackets.getModule(<span class="string">'utils/EventDispatcher'</span>),
    editorVariableManager = require(<span class="string">'./editorVariableManager'</span>),
    loggerForTest = require(<span class="string">'./loggerForTest'</span>);

  <span class="keyword">var</span> SPEED_FACTOR = <span class="number">120</span>;
  <span class="keyword">var</span> EPSYLON_PERCENTAGE = <span class="number">0.1</span>;

  <span class="keyword">var</span> verticalScrollCharacterPos = <span class="literal">null</span>;
  <span class="comment">//Future: Save this to preferences (if I cant find a better way to adjust position)</span>
  <span class="keyword">var</span> manualOffset = {
    x: <span class="number">0</span>,
    y: <span class="number">0</span>
  };

  <span class="comment">//Future: Normalize the gaze data at the bridge level.</span>
  <span class="keyword">var</span> normalizeGazeDataXY = <span class="function"><span class="keyword">function</span> <span class="params">(gazeData, editorCoordInfo)</span> {</span>
    <span class="keyword">var</span> normalizedData = {};
    normalizedData.x = (gazeData.avg.x + manualOffset.x) - editorCoordInfo.x;
    normalizedData.y = (gazeData.avg.y + manualOffset.y) - editorCoordInfo.y;
    <span class="keyword">return</span> normalizedData;
  };

  <span class="keyword">var</span> calculateCursorOffset = <span class="function"><span class="keyword">function</span> <span class="params">(gazeData, useCursor)</span> {</span>
    <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
    <span class="keyword">var</span> cursorCoords = {
      x: <span class="number">0</span>,
      y: <span class="number">0</span>
    };
    <span class="keyword">if</span> (useCursor) {
      cursorCoords = editorVariableManager.getCursorCoords();
    }

    <span class="keyword">var</span> charSize = editorVariableManager.getCharSize();
    <span class="keyword">var</span> editorCoordInfo = editorVariableManager.getCurrentEditorSizeAndCoords();
    <span class="keyword">var</span> normalizedGazeData = normalizeGazeDataXY(gazeData, editorCoordInfo);
    <span class="keyword">var</span> scrolledLines = editorVariableManager.getScrolledLines();

    <span class="keyword">var</span> horizontalOffset = ~~((normalizedGazeData.x - cursorCoords.x) / charSize.width);
    <span class="keyword">var</span> verticalOffset = ~~((normalizedGazeData.y - cursorCoords.y) / charSize.height);

    <span class="keyword">return</span> {
      horizontal: horizontalOffset,
      vertical: verticalOffset + scrolledLines
    };
  };

  <span class="comment">//Future: Make velocity change exponential, not linear.</span>
  <span class="keyword">var</span> calculateYScrollVelocity = <span class="function"><span class="keyword">function</span> <span class="params">(gazeData)</span> {</span>
    <span class="keyword">var</span> editorCoordInfo = editorVariableManager.getCurrentEditorSizeAndCoords();
    <span class="keyword">var</span> normalizedGazeData = normalizeGazeDataXY(gazeData, editorCoordInfo);
    <span class="keyword">var</span> midPoint = editorCoordInfo.height / <span class="number">2</span>;
    <span class="keyword">var</span> epsylon = editorCoordInfo.height * EPSYLON_PERCENTAGE;
    <span class="keyword">var</span> speedFactor = SPEED_FACTOR / editorCoordInfo.height;
    <span class="keyword">var</span> velocityY = <span class="number">0</span>;

    <span class="comment">//Check if the user is looking close to the center</span>
    <span class="keyword">if</span> (Math.abs(normalizedGazeData.y - midPoint) > epsylon) {
      <span class="comment">//Check if the user is looking inside the editor window</span>
      <span class="keyword">if</span> (normalizedGazeData.y > <span class="number">0</span> || normalizedGazeData.y &lt;= editorCoordInfo.height) {
        velocityY = (normalizedGazeData.y - midPoint - epsylon) * speedFactor;
      }
    }
    <span class="keyword">return</span> velocityY;
  };

  <span class="keyword">var</span> cursorClick = <span class="function"><span class="keyword">function</span> <span class="params">(gazeData)</span> {</span>
    <span class="comment">//Future: Change this to the normalized access of the data.</span>
    <span class="keyword">if</span> (gazeData.avg.x !== <span class="number">0</span> &amp;&amp; gazeData.avg.y !== <span class="number">0</span>) {
      <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
      <span class="keyword">var</span> offset = calculateCursorOffset(gazeData, <span class="literal">false</span>);

      <span class="keyword">if</span> (editorVariableManager.isGoalLineWithinBorders(offset.vertical)) {
        curEditor.setCursorPos(offset.vertical, offset.horizontal);
      }
    }
  };

  <span class="keyword">var</span> verticalScroll = <span class="function"><span class="keyword">function</span> <span class="params">(gazeData)</span> {</span>
    <span class="comment">//Future: Change this to the normalized access of the data.</span>
    <span class="keyword">if</span> (gazeData.avg.x !== <span class="number">0</span> &amp;&amp; gazeData.avg.y !== <span class="number">0</span>) {

      <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
      <span class="keyword">var</span> curScrollPos = curEditor.getScrollPos();
      <span class="keyword">var</span> velocity = calculateYScrollVelocity(gazeData);

      curEditor.setScrollPos(curScrollPos.x, curScrollPos.y + velocity);
    }
  };

  <span class="keyword">var</span> verticalCursorScroll = <span class="function"><span class="keyword">function</span> <span class="params">(gazeData)</span> {</span>
    <span class="comment">//Future: Change this to the normalized access of the data.</span>
    <span class="keyword">if</span> (gazeData.avg.x !== <span class="number">0</span> &amp;&amp; gazeData.avg.y !== <span class="number">0</span>) {

      <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
      <span class="keyword">var</span> cursorPos = curEditor.getCursorPos();
      <span class="keyword">var</span> cursorOffset = calculateCursorOffset(gazeData, <span class="literal">true</span>);

      <span class="keyword">var</span> goalLinePos = cursorPos.line + cursorOffset.vertical;

      <span class="keyword">if</span> (editorVariableManager.isGoalLineWithinBorders(goalLinePos)) {
        curEditor.setCursorPos(goalLinePos, verticalScrollCharacterPos);
      }
    }
  };

  <span class="keyword">var</span> horizontalCursorScroll = <span class="function"><span class="keyword">function</span> <span class="params">(gazeData)</span> {</span>
    <span class="comment">//Future: Change this to the normalized access of the data.</span>
    <span class="keyword">if</span> (gazeData.avg.x !== <span class="number">0</span> &amp;&amp; gazeData.avg.y !== <span class="number">0</span>) {

      <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
      <span class="keyword">var</span> cursorPos = curEditor.getCursorPos();
      <span class="keyword">var</span> cursorOffset = calculateCursorOffset(gazeData, <span class="literal">true</span>);

      <span class="keyword">var</span> goalCursorPos = cursorPos.ch + cursorOffset.horizontal;
      curEditor.setCursorPos(cursorPos.line, goalCursorPos);
    }
  };

  <span class="keyword">var</span> arrowKeysMovements = <span class="function"><span class="keyword">function</span> <span class="params">(direction)</span> {</span>
    <span class="keyword">var</span> passedDirection = direction;

    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
      <span class="keyword">var</span> cursorPos = curEditor.getCursorPos();

      <span class="keyword">var</span> goalCursorPos = {
        ch: cursorPos.ch,
        line: cursorPos.line
      };

      <span class="keyword">switch</span> (passedDirection) {
      <span class="keyword">case</span> <span class="string">'up'</span>:
        goalCursorPos.line -= <span class="number">1</span>;
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'down'</span>:
        goalCursorPos.line += <span class="number">1</span>;
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'left'</span>:
        goalCursorPos.ch -= <span class="number">1</span>;
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'right'</span>:
        goalCursorPos.ch += <span class="number">1</span>;
        <span class="keyword">break</span>;
      <span class="keyword">default</span>:
        <span class="keyword">break</span>;
      }

      curEditor.setCursorPos(goalCursorPos.line, goalCursorPos.ch);
    };
  };

  <span class="keyword">var</span> setManualOffset = <span class="function"><span class="keyword">function</span> <span class="params">(xOffset, yOffset)</span> {</span>
    <span class="keyword">var</span> xOff = xOffset;
    <span class="keyword">var</span> yOff = yOffset;

    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> charSize = editorVariableManager.getCharSize();
      <span class="keyword">var</span> direction = <span class="string">""</span>;
      manualOffset.x += xOff * charSize.width;
      manualOffset.y += yOff * charSize.height;

      <span class="keyword">if</span> (xOff === -<span class="number">1</span>) direction = <span class="string">"left"</span>;
      <span class="keyword">else</span> <span class="keyword">if</span> (xOff === <span class="number">1</span>) direction = <span class="string">"right"</span>;
      <span class="keyword">else</span> <span class="keyword">if</span> (yOff === -<span class="number">1</span>) direction = <span class="string">"up"</span>;
      <span class="keyword">else</span> <span class="keyword">if</span> (yOff === <span class="number">1</span>) direction = <span class="string">"down"</span>;

      arrowKeysMovements(direction)();
    };
  };

  <span class="keyword">var</span> selectHoveredWord = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
    <span class="keyword">var</span> currentCursor = curEditor.getCursorPos();
    <span class="keyword">var</span> token = editorVariableManager.getToken(currentCursor);

    curEditor.setSelection({
      line: currentCursor.line,
      ch: token.start
    }, {
      line: currentCursor.line,
      ch: token.end
    });
  };

  <span class="comment">//Future: Think of a more flexible implementation of this (including the checking of verticalCursorScroll)</span>
  <span class="keyword">var</span> executeMovement = <span class="function"><span class="keyword">function</span> <span class="params">(actionToExecute, funcArguments)</span> {</span>
    <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
    <span class="keyword">var</span> cursorPos = curEditor.getCursorPos();

    <span class="keyword">if</span> (actionToExecute === <span class="keyword">this</span>.verticalCursorScroll) {
      <span class="keyword">if</span> (!verticalScrollCharacterPos)
        verticalScrollCharacterPos = cursorPos.ch;
    } <span class="keyword">else</span> {
      verticalScrollCharacterPos = <span class="literal">null</span>;
    }

    actionToExecute.apply(<span class="literal">undefined</span>, funcArguments);
  };

  exports.cursorClick = cursorClick;
  exports.horizontalCursorScroll = horizontalCursorScroll;
  exports.verticalCursorScroll = verticalCursorScroll;
  exports.verticalScroll = verticalScroll;
  exports.executeMovement = executeMovement;
  exports.arrowKeysMovements = arrowKeysMovements;
  exports.setManualOffset = setManualOffset;
  exports.selectHoveredWord = selectHoveredWord;
});</code></pre>