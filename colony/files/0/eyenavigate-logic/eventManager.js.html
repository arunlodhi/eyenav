<h1>eventManager.js</h1>
<pre><code class="lang-js">define(<span class="function"><span class="keyword">function</span> <span class="params">(require, exports, module)</span> {</span>
  <span class="string">'use strict'</span>;

  <span class="keyword">var</span> EditorManager = brackets.getModule(<span class="string">'editor/EditorManager'</span>),
    KeyEvent = brackets.getModule(<span class="string">'utils/KeyEvent'</span>),
    keyManager = require(<span class="string">'./keyManager'</span>),
    movements = require(<span class="string">'./movements'</span>);

  <span class="keyword">var</span> keys = keyManager.keys;

  <span class="comment">//keyEvent is depricated, use keydown/press/up</span>
  <span class="keyword">var</span> keyEventHandler = <span class="function"><span class="keyword">function</span> <span class="params">(bracketsEvent, editor, event)</span> {</span>
    <span class="keyword">var</span> key = keyManager.getKeyFromCodeAndLocation(event.keyCode, event.location);
    <span class="comment">//console.log('Key code: ' + event.keyCode + ', key location: ' + event.location);</span>
    <span class="keyword">if</span> (key) {
      <span class="keyword">if</span> (event.type === <span class="string">'keydown'</span>) {
        keyManager.setKeyPressed(key);
      } <span class="keyword">else</span> <span class="keyword">if</span> (event.type === <span class="string">'keyup'</span>) {
        keyManager.setKeyReleased(key);
      }

      <span class="comment">//Future: Maybe prevent default for the commandToggle button itself (may not be necessary)</span>
      <span class="keyword">if</span> (keyManager.isValidKeyCommand(key)) {
        event.preventDefault();
      }
    }
  };

  <span class="comment">//This is the main loop of the program.</span>
  <span class="keyword">var</span> eyeTribeHanlder = <span class="function"><span class="keyword">function</span> <span class="params">(info, gazeData)</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> keys) {
      <span class="keyword">if</span> (keyManager.isValidKeyCommand(keys[key])) {
        movements.executeMovement(keys[key].func, [gazeData]);

        <span class="keyword">if</span> (keys[key].releaseAfterFunc) {
          keyManager.setKeyReleased(keys[key]);
        }
      }
    }
  };

  <span class="keyword">var</span> activeEditorChangeHandler = <span class="function"><span class="keyword">function</span> <span class="params">($event, focusedEditor, lostEditor)</span> {</span>
    <span class="keyword">if</span> (lostEditor) {
      lostEditor.off(<span class="string">'keyup'</span>, keyEventHandler);
      lostEditor.off(<span class="string">'keydown'</span>, keyEventHandler);
    }
    <span class="keyword">if</span> (focusedEditor) {
      focusedEditor.on(<span class="string">'keyup'</span>, keyEventHandler);
      focusedEditor.on(<span class="string">'keydown'</span>, keyEventHandler);
    }
  };
  
  <span class="keyword">var</span> toggleTool = <span class="function"><span class="keyword">function</span> <span class="params">(toggle, domain)</span> {</span>
    <span class="keyword">var</span> curEditor = EditorManager.getCurrentFullEditor();
    
    <span class="keyword">if</span> (toggle) {
      EditorManager.on(<span class="string">'activeEditorChange'</span>, activeEditorChangeHandler);
      <span class="keyword">if</span> (curEditor) {
        activeEditorChangeHandler(<span class="literal">null</span>, curEditor, <span class="literal">null</span>);
      }
      domain.on(<span class="string">'gazeChanged'</span>, eyeTribeHanlder);
      domain.exec(<span class="string">'start'</span>);
    } <span class="keyword">else</span> {
      EditorManager.off(<span class="string">'activeEditorChange'</span>, activeEditorChangeHandler);
      <span class="keyword">if</span> (curEditor) {
        activeEditorChangeHandler(<span class="literal">null</span>, <span class="literal">null</span>, curEditor);
      }
      domain.off(<span class="string">'gazeChanged'</span>, eyeTribeHanlder);
      domain.exec(<span class="string">'stop'</span>);
    }
  };

  module.exports.toggleTool = toggleTool;
});</code></pre>